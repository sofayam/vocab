<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<link rel="stylesheet" href="/static/easyautocomplete/easy-autocomplete.css" />
<script src="/static/easyautocomplete/jquery.easy-autocomplete.js"></script>

<h1> Vocab Capture </h1>

<form id="vocab">
    <table>
        <tr>
            <td>
                Word:
            </td>
            <td>
                <input type="text" id="word">
            </td>
        </tr>
        <tr>
            <td>
                Meaning:
            </td>
            <td>
                <input type="text" id="meaning">
            </td>
        </tr>
        <tr>
            <td>
                Type:
            </td>
            <td>
                <input type="text" id="type">
            </td>
        </tr>
        <tr>
            <td>
                Context:
            </td>
            <td>
                <input type="text" id="context">
            </td>
        </tr>
        <tr>
            <td>
                Example:
            </td>
            <td>
                <textarea rows="2" cols="30" id="example">

                </textarea>
            </td>
        </tr>
        <tr>
            <td>
                Visits:
            </td>
            <td>
                <input type="text" id="visits">
            </td>
        </tr>
        <tr>
            <td>
                Created:
            </td>
            <td>
                <input type="text" id="created">
            </td>
        </tr>
    </table>
</form>
<button id=save>save</button>
...........
<button id=bump>bump</button>
...........
<button id=delete>delete</button>
<script>
    let fields = ["meaning", "context", "type", "example", "visits", "created"]
    armDirty();
    $("#delete").click(function (event) {
        let myForm = document.forms["vocab"];
        let data = { word: myForm.word.value };
        if (confirm("For realsies?")) {
            $.ajax({
                url: "/kill",
                type: "POST",
                data,
                datatype: "json",
                success: function (data) {
                    stuffContents({}, true);
                },
                error: function (request, error) {
                    alert("Error " + JSON.stringify(error));
                }
            })
        }
    })
    $("#bump").click(function (event) {
        let myForm = document.forms["vocab"]
        let ctr = myForm.visits.value
        if(ctr) {
            ctr = parseInt(ctr)
        } else {
            ctr = 0
        }
        ctr += 1;
        $("#visits").val(ctr);
        $("#visits").css({ "background": "pink" });
    })
    $("#save").mouseup(function (event) {
        let myForm = document.forms["vocab"]
        let data = {
            word: myForm.word.value,
            meaning: myForm.meaning.value,
            context: myForm.context.value,
            type: myForm.type.value,
            example: myForm.example.value,
            created: myForm.created.value || new Date(),
            visits: myForm.visits.value,
        };
        $.ajax({
            url: "/save",
            type: "POST",
            data,
            datatype: "json",
            success: function (data) {
                //alert("Success" + JSON.stringify(data))
                stuffContents({}, true);
                $("#word").focus();
                $("#word").select();
            },
            error: function (request, error) {
                alert("Error " + JSON.stringify(error));
            }
        })
    })
    let options = {
        url: function (phrase) {
            return "find";
        },
        getValue: function (element) {
            return element.word;
        },
        ajaxSettings: {
            dataType: "json",
            method: "POST",
            data: {
                dataType: "json"
            }
        },
        list: {
            onChooseEvent: function () {
                //alert("selected " + JSON.stringify($("#word").getSelectedItemData()))
                stuffContents($("#word").getSelectedItemData())
            }
        },
        preparePostData: function (data) {
            data.fragment = $("#word").val();
            return data;
        }
    }

    $("#word").easyAutocomplete(options);
    $("#word").keypress(function (event) {
        var keycode = (event.keyCode ? event.keyCode : event.which);
        if (keycode == '13') {
            // see if there is anything in the dictionary already
            let myForm = document.forms["vocab"]
            let data = { word: myForm.word.value }
            $.ajax({
                url: "/fetch",
                type: "POST",
                data,
                datatype: "json",
                success: function (data) {
                    if (data.length > 0) {
                        stuffContents(data[0])
                    } else {
                        stuffContents({})
                    }

                },
                error: function (request, error) {
                    alert("Error " + JSON.stringify(error));
                }
            })
        }
    });
    $("#find").click(function (event) {
        let myForm = document.forms["vocab"]
        let data = { fragment: myForm.word.value }
        $.ajax({
            url: "/find",
            type: "POST",
            data,
            datatype: "json",
            success: function (data) {
                alert("Success" + JSON.stringify(data))
            },
            error: function (request, error) {
                alert("Error " + JSON.stringify(error));
            }
        })
    })

    function stuffContents(data, full) {
        clean();
        for (field of fields) {
            $("#" + field).val(data[field])
        }
        if (full) {
            $("#word").val(data.word);
        }
    }
    function armDirty() {
        for (field of fields) {
            let f = function (fld) {
                $(fld).keypress(function (event) {
                    $(fld).css({ "background": "pink" });
                })
            }
            f("#" + field);
        }
    }
    function clean() {
        for (field of fields) {
            $("#" + field).css({ "background": "white" });
        }
    }
</script>